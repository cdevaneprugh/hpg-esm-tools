# CTSM Upstream Check - 2025-01-11

## Current Status

| Item | Value |
|------|-------|
| Local version | ctsm5.3.059 |
| Upstream | origin/master |
| Commits behind | 1114 |
| Latest 5.3.x | ctsm5.3.085 (26 patch releases ahead) |
| Latest 5.4.x | ctsm5.4.007 (new major version) |

---

## High Priority Changes

### Hillslope/Lateral Hydrology
**None found.** No commits matching hillslope, lateral, or aquifer keywords.

### Single-point/Subset Data (19 commits)

Key fixes:
- `9f5e4b4d1` - Fix subset_data when selecting just 1 pft
- `367317ecb` - Fix --create-surface Longitude TypeError
- `daa218c09` - Fix --create-landuse Longitude TypeError
- `3f5d157ac` - Fix --create-datm Longitude TypeError
- `1022b000d` - Fix subset_data call condition
- `139c876a1` - Run subset_data if outputs don't exist
- `5a3ae010c` - Add SUBSETDATAPOINT system test
- `c6c6cadc5` - Add SUBSETDATAREGION SystemTest

### Biogeochemistry (59 commits)

- Carbon isotope (C13/C14) streams overhaul
- Fire code cleanup
- Various error handling improvements

### Biogeophysics (28 commits)

- `918af16f0` - Fix for RRTMGP errors caused by high surface temperatures
- `a33f75fa4` - Add min_lai parameter
- Carbon isotope data movement to clm_driver
- VEGWP restart/history changes

### Bug Fixes in src/

- RRTMGP high surface temperature fix
- C13/C14 isotope read fixes
- `a7fd23ca2` - h1i file naming bug fix
- Various compiler fixes (NAG)

---

## Medium Priority

- CIME config: 170 commits changed
- Documentation converted to markdown
- ChangeLog updates for multiple releases
- Parameter file comparison tools improved

---

## Recommendation

**UPGRADE RECOMMENDED to ctsm5.3.085** (stay on 5.3.x branch)

### Reasons

1. **No hillslope changes** - your hillslope work won't conflict
2. **Important bug fixes** - RRTMGP temperature, file naming
3. **subset_data improvements** - directly relevant to your workflow
4. **26 patch releases** is significant technical debt
5. **5.4.x available** but would be a larger jump

---

## Upgrade Steps (when ready)

```bash
cd /blue/gerber/cdevaneprugh/ctsm5.3

# Save any local changes
git stash

# Checkout new version
git checkout ctsm5.3.085

# Update submodules
git submodule update --init --recursive

# Rebuild cases
cd $CASES/<case>
./case.build --clean-all
./case.build
```

### Test before production
Run a simple test case before any production runs to verify the upgrade.

---

## subset_data Fix Details

### Fix: subset_data when selecting just 1 PFT

**Commit:** `9f5e4b4d1`

**Problem:** When using `--drop-other-pfts` with just 1 PFT, the script failed due to numpy dimension mismatch - a scalar was being assigned where a 1D array was expected.

**Solution:** Added check to convert scalar to 1D array:
```python
# This can happen if, e.g., you're selecting and changing just one PFT
if ds_in[var].values.ndim > 0 and new_value.ndim == 0:
    new_value = np.atleast_1d(new_value)
```

### Longitude TypeError Fixes

Three commits fixed TypeErrors in `single_point_case.py`:
- `--create-surface`
- `--create-landuse`
- `--create-datm`

Issues with longitude value handling in subsetting logic.

---

## Notes

- Generated by `/upstream-check ctsm` slash command
- Check should be re-run before upgrade to catch any new changes
- Consider testing subset_data fixes specifically if you've encountered those errors
