# CTSM Deterministic Testing and Hash Comparison Analysis

## Executive Summary

This document presents a comprehensive analysis of deterministic behavior in the Community Terrestrial Systems Model (CTSM) through hash comparison testing. Two identical model cases were executed and their outputs analyzed to determine the viability of using file hash comparison for model validation and reproducibility testing.

**Key Finding**: CTSM exhibits **component-specific deterministic behavior** - some model components (coupler, data atmosphere) produce identical outputs across runs, while others (CLM land model) show variations despite identical configurations.

---

## 1. Background and Methodology

### 1.1 Purpose
Investigate whether CTSM model runs are deterministic enough to use file hash comparison for:
- Model validation and quality assurance
- Baseline comparison testing
- Scientific reproducibility verification
- Integration into automated analysis workflows

### 1.2 Testing Framework
The analysis leveraged existing CIME/CESM infrastructure for deterministic testing:
- **CPRNC tool**: Found at `/blue/gerber/cdevaneprugh/ctsm5.3-development/cime/CIME/non_py/cprnc/`
- **CIME baseline testing**: Built-in framework in `/blue/gerber/cdevaneprugh/ctsm5.3-development/cime/CIME/hist_utils.py`
- **Hash comparison methods**: MD5 checksums and Python-based variable comparison

### 1.3 Literature Review Results
Research into CTSM/CESM documentation revealed:
- **Established testing protocols** requiring bit-for-bit restart reproducibility
- **Baseline comparison systems** for detecting answer-changing code modifications
- **CPRNC integration** for automated NetCDF file comparison in validation workflows
- **Platform-specific limitations** where perfect reproducibility may vary due to compiler/system differences

---

## 2. Test Case Configuration

### 2.1 Hash Test Cases Created
Two identical test cases were executed:

**Hash Test 1:**
- Directory: `/blue/gerber/cdevaneprugh/cases/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/`
- Run Directory: `/blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/run/`

**Hash Test 2:**
- Directory: `/blue/gerber/cdevaneprugh/cases/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/`
- Run Directory: `/blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/run/`

### 2.2 Model Configuration Analysis

**Command used to query run configuration:**
```bash
cd hash.test1.I1850Clm50SpCru.f19_g17.250917-090114
./xmlquery RUN_STARTDATE,STOP_OPTION,STOP_N,RESUBMIT
```

**Results for both cases (identical):**
```
RUN_STARTDATE: 0001-01-01    # Start from model year 1, January 1st
STOP_OPTION: ndays           # Stop criterion is number of days
STOP_N: 5                    # Run for 5 days total
RESUBMIT: 0                  # No automatic resubmission
```

**Configuration Analysis:**
- **Compset**: `I1850Clm50SpCru` (1850 control simulation with CLM5.0, satellite phenology, CRU forcing)
- **Resolution**: `f19_g17` (approximately 2-degree atmosphere/land grid)
- **Simulation Length**: 5 days (minimal test duration for rapid turnaround)
- **Model Version**: CTSM 5.3-development branch
- **Compiler Environment**: GCC 14.2.0 with OpenMPI 5.0.7 (from environment analysis)

---

## 3. Output File Analysis

### 3.1 File Inventory Commands
```bash
# Count total NetCDF files generated by each test
find /blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/ -name "*.nc" -type f | wc -l
find /blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/ -name "*.nc" -type f | wc -l
```

**Result**: Both cases generated exactly **7 NetCDF files each**

### 3.2 Detailed File Analysis

**Command used to examine output file structure:**
```bash
ls -la /blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/run/ | head -15
```

### 3.3 Generated Files Inventory

| File Type | File Name Pattern | Size (MB) | Purpose |
|-----------|-------------------|-----------|---------|
| **CLM Restart** | `*.clm2.r.0001-01-06-00000.nc` | 197 | Land model state at day 6 |
| **CLM Restart History** | `*.clm2.rh0.0001-01-06-00000.nc` | 94 | Land model history restart |
| **Coupler Restart** | `*.cpl.r.0001-01-06-00000.nc` | 59 | Coupler component state |
| **DATM Restart** | `*.datm.r.0001-01-06-00000.nc` | 28 | Data atmosphere state |
| **MOSART Restart** | `*.mosart.r.0001-01-06-00000.nc` | 29 | River routing model state |
| **MOSART Restart History** | `*.mosart.rh0.0001-01-06-00000.nc` | 38 | River routing history restart |
| **Additional Config Files** | Various | <1 | Model configuration and metadata |

**Total storage per case**: ~445 MB

### 3.4 File Naming Convention Analysis
The restart files follow CIME naming convention:
- `<CASENAME>.<COMPONENT>.<FILETYPE>.<DATE>-<TIME>.nc`
- Date format: `0001-01-06-00000` = Year 1, Month 1, Day 6, Time 00000 seconds
- This indicates both runs completed the full 5-day simulation (started Jan 1, ended Jan 6)

---

## 4. Hash Comparison Analysis

### 4.1 MD5 Hash Comparison Methodology

**Commands used for hash comparison:**
```bash
# CLM restart files comparison
md5sum hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/run/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114.clm2.r.0001-01-06-00000.nc hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/run/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123.clm2.r.0001-01-06-00000.nc

# Coupler restart files comparison
md5sum hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/run/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114.cpl.r.0001-01-06-00000.nc hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/run/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123.cpl.r.0001-01-06-00000.nc

# DATM restart files comparison
md5sum hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/run/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114.datm.r.0001-01-06-00000.nc hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/run/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123.datm.r.0001-01-06-00000.nc
```

### 4.2 Hash Comparison Results

#### 4.2.1 CLM Component (Land Model)
```
Hash Test 1: 5b0ddc647c1ddbc017ea453a9045925d
Hash Test 2: 1add8126655f1029a26faab0ceb4320a
Result: ❌ DIFFERENT
```

**Analysis**: The CLM land model component shows **non-deterministic behavior** between identical runs. This is the most significant finding, as CLM is the primary component of CTSM.

#### 4.2.2 Coupler Component
```
Hash Test 1: 2f60ae9cb6b0d71f131bdfbf7a0aee41
Hash Test 2: 2f60ae9cb6b0d71f131bdfbf7a0aee41
Result: ✅ IDENTICAL
```

**Analysis**: The CIME coupler component demonstrates **perfect bit-for-bit reproducibility**.

#### 4.2.3 DATM Component (Data Atmosphere)
```
Hash Test 1: d1ea185c5e0d07cd9cab60f8e2456685
Hash Test 2: d1ea185c5e0d07cd9cab60f8e2456685
Result: ✅ IDENTICAL
```

**Analysis**: The data atmosphere component shows **perfect bit-for-bit reproducibility**.

### 4.3 Hash Comparison Summary Table

| Component | File Size (MB) | Hash Match | Deterministic | Notes |
|-----------|----------------|------------|---------------|-------|
| **CLM Land Model** | 197 | ❌ Different | No | Primary component, shows variability |
| **Coupler** | 59 | ✅ Identical | Yes | Perfect reproducibility |
| **DATM** | 28 | ✅ Identical | Yes | Perfect reproducibility |
| **MOSART** | 29 | *Not tested* | Unknown | River routing component |
| **CLM History** | 94 | *Not tested* | Unknown | History restart files |
| **MOSART History** | 38 | *Not tested* | Unknown | River routing history |

---

## 5. Scientific Variable Comparison

### 5.1 Python-Based Variable Analysis

Since CPRNC had library dependency issues, Python with xarray was used for detailed variable comparison:

**Command used:**
```python
import xarray as xr
import numpy as np

file1 = '/blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/run/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114.cpl.r.0001-01-06-00000.nc'
file2 = '/blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/run/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123.cpl.r.0001-01-06-00000.nc'

ds1 = xr.open_dataset(file1)
ds2 = xr.open_dataset(file2)

# Compare all data variables using numpy array comparison
different_vars = []
for var in ds1.data_vars:
    if var in ds2.data_vars:
        if not np.array_equal(ds1[var].values, ds2[var].values, equal_nan=True):
            different_vars.append(var)
```

### 5.2 Variable Comparison Results

**Coupler restart file analysis:**
- **Total variables**: 169 in each file
- **Variables with differences**: 0
- **Comparison method**: `numpy.array_equal()` with NaN handling
- **Result**: All 169 variables are **IDENTICAL** at the array level

**This confirms that hash comparison accurately reflects scientific content** - identical hashes correspond to identical variable arrays.

---

## 6. CPRNC Tool Investigation

### 6.1 CPRNC Location and Setup
```bash
# CPRNC tool location discovered
find /blue/gerber/earth_models/shared/cprnc -name "cprnc*" -type f

# Found files:
/blue/gerber/earth_models/shared/cprnc/cprnc.F90          # Source code
/blue/gerber/earth_models/shared/cprnc/bld/cprnc          # Executable
/blue/gerber/earth_models/shared/cprnc/bld/CMakeFiles/cprnc.dir/cprnc.F90.o  # Object file
```

### 6.2 CPRNC Execution Attempt
```bash
# Command attempted:
/blue/gerber/earth_models/shared/cprnc/bld/cprnc -m file1.nc file2.nc

# Error encountered:
error while loading shared libraries: libnetcdff.so.7: cannot open shared object file: No such file or directory
```

**Issue Analysis**: CPRNC requires NetCDF Fortran libraries that aren't available in the current environment. This is likely due to:
- Module environment not loaded properly
- Library path configuration issues
- Version mismatch between CPRNC build and runtime environment

**Workaround**: Python-based comparison using xarray provided equivalent functionality for this analysis.

---

## 7. Implications for Model Development and Testing

### 7.1 Component-Specific Determinism

**Deterministic Components:**
- **Coupler (CPL)**: Manages inter-component communication - shows perfect reproducibility
- **Data Atmosphere (DATM)**: Reads prescribed atmospheric forcing - deterministic by design
- **Likely others**: Components with simpler physics or prescribed inputs

**Non-Deterministic Components:**
- **CLM Land Model**: Complex terrestrial physics with potential sources of variability:
  - Random number generation for stochastic processes
  - Floating-point accumulation order dependencies
  - Memory initialization differences
  - Complex biogeochemical calculations

### 7.2 Practical Applications

#### 7.2.1 Where Hash Comparison IS Effective:
1. **File Integrity Verification**: Ensuring data transfer/archival preserves bit-perfect copies
2. **Configuration Validation**: Verifying setup scripts produce expected baseline results
3. **Platform Testing**: Quick checks for major computational environment changes
4. **Component-Level Testing**: Validating deterministic components like coupler and data models

#### 7.2.2 Where Hash Comparison is NOT Sufficient:
1. **Scientific Validation**: Comparing results between different model configurations
2. **Cross-Platform Validation**: Results may differ due to compiler/architecture variations
3. **Development Testing**: Code changes may preserve scientific validity while changing hashes
4. **Parameter Studies**: Expected differences require scientific rather than bit-level comparison

### 7.3 Recommended Testing Strategy

**Tiered Approach:**
1. **Level 1 - Hash Screening**: Quick hash comparison for obvious differences or identity
2. **Level 2 - CPRNC Analysis**: Scientific difference quantification for related configurations
3. **Level 3 - Statistical Testing**: Domain expert analysis for scientific significance

---

## 8. Technical Infrastructure Observations

### 8.1 CIME Directory Structure
The test confirmed the path structure differences identified earlier:

**Global/Standard Cases:**
- Case directory: `/blue/gerber/cdevaneprugh/cases/<casename>/`
- Build/Run output: `/blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/<casename>/`

**NEON Cases:**
- Case directory: `/blue/gerber/cdevaneprugh/cases/<casename>/`
- Build/Run output: `<casename>/bld/` and `<casename>/run/` (local to case)

### 8.2 Environment Dependencies
The analysis revealed several technical dependencies:
- **Module System**: `lmod` commands don't work through automated interfaces
- **Library Dependencies**: CPRNC requires specific NetCDF library versions
- **Python Environment**: xarray/netCDF4 provide robust alternative for file analysis
- **Permissions**: Analysis requires read access to output directories in `/blue/gerber/earth_model_output/`

---

## 9. Conclusions and Recommendations

### 9.1 Key Findings Summary

1. **CTSM exhibits component-specific deterministic behavior**
2. **Hash comparison is a valid tool** for specific use cases (integrity, exact replication)
3. **Scientific comparison requires more sophisticated tools** than simple hash comparison
4. **Existing CIME infrastructure supports deterministic testing** but needs proper environment setup

### 9.2 Recommendations for Analysis Scripts

#### 9.2.1 Implement Multi-Level Validation:
```python
def validate_model_output(file1, file2):
    """
    Multi-level validation strategy for CTSM outputs
    """
    # Level 1: Hash comparison for quick screening
    hash_match = compare_file_hashes(file1, file2)

    if hash_match:
        return "IDENTICAL - perfect reproduction"

    # Level 2: Variable-level comparison
    scientific_diff = compare_scientific_variables(file1, file2)

    # Level 3: Statistical significance testing
    # (implement based on domain expertise)

    return validation_report
```

#### 9.2.2 Component-Aware Testing:
- Use hash comparison for coupler and data model components
- Use scientific comparison for land model components
- Document expected determinism levels by component

#### 9.2.3 Integration with Existing Tools:
- Set up proper environment for CPRNC usage
- Leverage CIME baseline testing framework
- Build on existing `hist_utils.py` comparison infrastructure

### 9.3 Future Work

1. **Extended Testing**: Run longer simulations to assess determinism over time
2. **Component Analysis**: Test each model component individually
3. **Platform Testing**: Compare determinism across different HPC systems
4. **Tool Development**: Create unified validation framework combining hash and scientific comparison
5. **Documentation**: Develop best practices guide for CTSM reproducibility testing

---

## 10. Appendix

### 10.1 Complete Command History
```bash
# Case configuration queries
cd hash.test1.I1850Clm50SpCru.f19_g17.250917-090114
./xmlquery RUN_STARTDATE,STOP_OPTION,STOP_N,RESUBMIT
./xmlquery RUNDIR

cd ../hash.test2.I1850Clm50SpCru.f19_g17.250917-090123
./xmlquery RUN_STARTDATE,STOP_OPTION,STOP_N,RESUBMIT
./xmlquery RUNDIR

# File inventory and analysis
find /blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/ -name "*.nc" -type f | wc -l
find /blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/ -name "*.nc" -type f | wc -l

ls -la /blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/run/
ls -la /blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/run/

# Hash comparisons
md5sum [various file pairs as shown in results sections]

# Python-based variable comparison
python -c "[xarray comparison script as shown above]"

# CPRNC investigation
find /blue/gerber/earth_models/shared/cprnc -name "cprnc*" -type f
/blue/gerber/earth_models/shared/cprnc/bld/cprnc -m file1.nc file2.nc
```

### 10.2 File Path Reference
```
# Case directories
/blue/gerber/cdevaneprugh/cases/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/
/blue/gerber/cdevaneprugh/cases/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/

# Output directories
/blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test1.I1850Clm50SpCru.f19_g17.250917-090114/run/
/blue/gerber/cdevaneprugh/earth_model_output/cime_output_root/hash.test2.I1850Clm50SpCru.f19_g17.250917-090123/run/

# Tools and utilities
/blue/gerber/earth_models/shared/cprnc/bld/cprnc
/blue/gerber/cdevaneprugh/ctsm5.3-development/cime/CIME/non_py/cprnc/
/blue/gerber/cdevaneprugh/ctsm5.3-development/cime/CIME/hist_utils.py
```

---

**Document Version**: 1.0
**Analysis Date**: September 17, 2025
**Author**: CTSM Analysis Framework Development
**Environment**: HiPerGator, University of Florida